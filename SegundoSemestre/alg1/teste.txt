#include "frequentes.h"

string_t lerPalavra(int *fimDaLinha, int *eof){
    scanf("%*[\r\n]s");
    string_t string = malloc(sizeof(char));
    int caracteres = 0;
    int nmrMaxChar = 1;
    do{
        string[caracteres] = getchar();
        if (string[caracteres] == '\n'){
            *fimDaLinha = 1;
            if (string[caracteres - 1] == '\r')
                caracteres--;
            string[caracteres] = '\0';
        }
        else if (string[caracteres] == ' '){
            string[caracteres] = '\0';
        }
        caracteres++;
        if (caracteres == nmrMaxChar)
        {
            nmrMaxChar *= 2;
            string = realloc(string, (nmrMaxChar) * sizeof(char));
        }

    }while (string[caracteres-1] != '\0');
    string = realloc(string, (caracteres + 1) * sizeof(char));

    return string;
}


palavras_t* lerEntrada(palavras_t *palavras, int *eof, int *fimDaLinha, int *totalPalavras){
    int quantidadeImpressoes;
    while(!(*eof)) {
        while (!(*fimDaLinha)) {
            palavras = realloc(palavras, (*totalPalavras + 1) * sizeof (palavras_t));
            palavras[*totalPalavras].palavra = lerPalavra(fimDaLinha, eof);
            palavras[*totalPalavras].repeticoes = -1;
            palavras[*totalPalavras].visitada = 0;
            (*totalPalavras)++;
        }
        scanf("%d", &quantidadeImpressoes);
        char c = getchar();
        if (c == EOF)
            *eof = 1;
        if (quantidadeImpressoes > *totalPalavras){
            imprimindoPalavras(palavras, *totalPalavras, 0);
        }
        calculandoRepeticoes(palavras, totalPalavras);
        ordenandoPorRepeticoes(palavras, 0, *totalPalavras);

        int palavrasRepetidas = 0;
        for (int i = 0; i < *totalPalavras; ++i)
            if (palavras[i].repeticoes == -1)
                palavrasRepetidas++;
        *totalPalavras = *totalPalavras - palavrasRepetidas;
        palavras = realloc(palavras, *totalPalavras * sizeof (palavras_t));
        ordenandoPorNome(palavras, *totalPalavras);

        imprimindoPalavras(palavras, quantidadeImpressoes, 1);
    }

    return palavras;
}


void calculandoRepeticoes(palavras_t *palavras, int *totalPalavras){
    for (int i = 0; i < *totalPalavras; ++i) {
        for (int j = i; j < *totalPalavras; ++j) {
            if (strcmp(palavras[i].palavra, palavras[j].palavra) == 0 && palavras[j].visitada == 0){
                palavras[j].visitada = 1;
                palavras[i].repeticoes++;
            }
        }
    }
}


void ordenandoPorRepeticoes(palavras_t *palavras, int esquerda, int direita){
    int dividindoVetor;
    if (esquerda < direita){
        dividindoVetor = dividir(palavras, esquerda, direita);
        ordenandoPorRepeticoes(palavras, esquerda, dividindoVetor - 1);
        ordenandoPorRepeticoes(palavras, dividindoVetor + 1, direita);
    }
}


int dividir(palavras_t *palavras, int esquerda, int direita){
    palavras_t auxiliar;
    int contador = esquerda;
    for (int i = esquerda + 1; i <= direita; ++i) {
        if (palavras[i].repeticoes > palavras[esquerda].repeticoes){
            contador++;

            auxiliar.repeticoes = palavras[i].repeticoes;
            auxiliar.visitada = palavras[i].visitada;
            auxiliar.palavra = realloc(auxiliar.palavra, (strlen(palavras[i].palavra) + 1) * sizeof (char));
            strcpy(auxiliar.palavra, palavras[i].palavra);

            palavras[i].repeticoes = palavras[contador].repeticoes;
            palavras[i].visitada = palavras[contador].visitada;
            palavras[i].palavra = realloc(palavras[i].palavra, (strlen(palavras[esquerda].palavra) + 1) * sizeof (char));
            strcpy(palavras[i].palavra, palavras[contador].palavra);

            palavras[esquerda].repeticoes = auxiliar.repeticoes;
            palavras[esquerda].visitada = auxiliar.visitada;
            palavras[esquerda].palavra = realloc(palavras[esquerda].palavra, (strlen(auxiliar.palavra) + 1) * sizeof(char));
            strcpy(palavras[esquerda].palavra, auxiliar.palavra);
        }
    }

    auxiliar.repeticoes = palavras[esquerda].repeticoes;
    auxiliar.visitada = palavras[esquerda].visitada;
    auxiliar.palavra = realloc(auxiliar.palavra, (strlen(palavras[esquerda].palavra) + 1) * sizeof (char));
    strcpy(auxiliar.palavra, palavras[esquerda].palavra);

    palavras[esquerda].repeticoes = palavras[contador].repeticoes;
    palavras[esquerda].visitada = palavras[contador].visitada;
    palavras[esquerda].palavra = realloc(palavras[contador].palavra, (strlen(palavras[esquerda].palavra) + 1) * sizeof (char));
    strcpy(palavras[esquerda].palavra, palavras[contador].palavra);

    palavras[contador].repeticoes = auxiliar.repeticoes;
    palavras[contador].visitada = auxiliar.visitada;
    palavras[contador].palavra = realloc(palavras[esquerda].palavra, (strlen(auxiliar.palavra) + 1) * sizeof(char));
    strcpy(palavras[contador].palavra, auxiliar.palavra);

    free(auxiliar.palavra);

    return contador;
}


void ordenandoPorNome(palavras_t *palavras, int totalPalavras){
    palavras_t auxiliar;
    for (int i = 0; i < totalPalavras; ++i) {
        for (int j = i + 1; palavras[i].repeticoes == palavras[j].repeticoes; ++j) {
            if (strcmp(palavras[i].palavra, palavras[j].palavra) > 0){
                auxiliar.repeticoes = palavras[i].repeticoes;
                auxiliar.visitada = palavras[i].visitada;
                auxiliar.palavra = realloc(auxiliar.palavra, (strlen(palavras[i].palavra) + 1) * sizeof (char));
                strcpy(auxiliar.palavra, palavras[i].palavra);

                palavras[i].repeticoes = palavras[j].repeticoes;
                palavras[i].visitada = palavras[j].visitada;
                palavras[i].palavra = realloc(palavras[i].palavra, (strlen(palavras[j].palavra) + 1) * sizeof (char));
                strcpy(palavras[i].palavra, palavras[j].palavra);

                palavras[j].repeticoes = auxiliar.repeticoes;
                palavras[j].visitada = auxiliar.visitada;
                palavras[j].palavra = realloc(palavras[j].palavra, (strlen(auxiliar.palavra) + 1) * sizeof(char));
                strcpy(palavras[j].palavra, auxiliar.palavra);
            }
        }
    }
}



void imprimindoPalavras(palavras_t *palavras, int quantidadeImpressoes, int imprimirRepeticoes){
    for (int i = 0; i < quantidadeImpressoes; ++i){
        printf("%s", palavras[i].palavra);
        if (imprimirRepeticoes)
            printf(" %d\n", palavras[i].repeticoes);
        else
            printf("\n");
    }
}


